---
title: "선거벽보"
description: |
  선관위 웹사이트에서 공개된 선거벽보를 데이터로 만듧니다.
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rvest)
library(httr)

```


# 데이터 {#poster-data}

중앙선거관리위원회 선거정보도서관, ["후보자 선전물"](http://elecinfo.nec.go.kr/neweps/3/1/paper.do) 벽보, 공보, 공약서 등 후보자 선전물 검색하여 데이터로 만듧니다.

## 제 19 대 대통령 {#president-19}

```{r crawl-poster}
library(tidyverse)
library(rvest)
library(httr)

poster_url <- "http://elecinfo.nec.go.kr/neweps/3/1/paperSearch.do?chs=&page=&epType=&start_file_sn=&end_file_sn=&svc_path_nm=&epid=&candidate_nm=&elect_ymd=&epdata_id=&ctl_no_id=&elect_sn=&party_nm=&win_yn=&elecDe=&turnDe=%B4%EB%C5%EB%B7%C9%BC%B1%B0%C5&elecType=10&code_id=10++&elecTypeMax=20&turnType=EPS0410++&cityType=EPS041019&guType=&sign_id=19&sido_nm=&elect_region_nm=&fieldName=candidate_nm&category=tms120tbl&myScraps=&kwd=&elecTypes=10&electionType=on&electionTurn=on&pageSize=20&order=elect_ymd&order_sort=desc"

poster_text <- poster_url %>% 
  read_html() %>% 
  html_nodes(xpath = '//*[@id="content"]/div[5]/ul') %>% 
  html_nodes(css = "li") %>% 
  html_nodes(css = "input") %>% 
  html_attr("value")

poster_list <- poster_text %>% 
  str_split(pattern = "(\\s+\\|\\s+)|(,)")

map(poster_list, str_remove, pattern = "|")  
map_chr(poster_list, 1)
map_chr(poster_list, 3)

poster_president_19_tbl <- tibble(후보      = map_chr(poster_list, 1),
                                  선거일    = map_chr(poster_list, 2),
                                  선거      = map_chr(poster_list, 3),
                                  선거구분  = map_chr(poster_list, 4),
                                  구분1     = map_chr(poster_list, 5),
                                  구분2     = map_chr(poster_list, 6),
                                  기호      = map_chr(poster_list, 7),
                                  정당      = map_chr(poster_list, 8),
                                  당락      = map_chr(poster_list, 9))

poster_president_19_tbl %>% 
  write_csv("data/poster_president_19_tbl.csv")

```


## 대통령 포스터 함수 {#president-poster-function}

대통령 선거는 1대부터 19대까지 진행되었습니다. 이에 따라 특정 대통령 선거를 넣게 되면 당선자 및 낙선자 기호 정당 등 관련 정보를 크롤링 하도록 코드를 작성한다.

```{r crawl-poster-number}

p_number <- 17

president_poster_url <- glue::glue("http://elecinfo.nec.go.kr/neweps/3/1/paperSearch.do?chs=&page=&epType=&start_file_sn=&end_file_sn=&svc_path_nm=&epid=&candidate_nm=&elect_ymd=&epdata_id=&ctl_no_id=&elect_sn=&party_nm=&win_yn=&elecDe=&turnDe=%B4%EB%C5%EB%B7%C9%BC%B1%B0%C5&elecType=10&code_id=10++&elecTypeMax=20&turnType=EPS0410++&cityType=EPS0410{p_number}&guType=&sign_id={p_number}&sido_nm=&elect_region_nm=&fieldName=candidate_nm&category=tms120tbl&myScraps=&kwd=&elecTypes=10&electionType=on&electionTurn=on&pageSize=20&order=elect_ymd&order_sort=desc")

poster_text <- president_poster_url %>% 
  read_html() %>% 
  html_nodes(xpath = '//*[@id="content"]/div[5]/ul') %>% 
  html_nodes(css = "li") %>% 
  html_nodes(css = "input") %>% 
  html_attr("value")

poster_list <- poster_text %>% 
  str_split(pattern = "(\\s+\\|\\s+)|(,)")

poster_president_tbl <- tibble(후보      = map_chr(poster_list, 1),
                               선거일    = map_chr(poster_list, 2),
                               선거      = map_chr(poster_list, 3),
                               선거구분  = map_chr(poster_list, 4),
                               구분1     = map_chr(poster_list, 5),
                               구분2     = map_chr(poster_list, 6),
                               기호      = map_chr(poster_list, 7),
                               정당      = map_chr(poster_list, 8),
                               당락      = map_chr(poster_list, 9))

poster_president_tbl
```

함수를 작성하여 테스트 한다.

```{r crawl-poster-number-function}

get_poster_info <- function(p_number) {

  president_poster_url <- glue::glue("http://elecinfo.nec.go.kr/neweps/3/1/paperSearch.do?chs=&page=&epType=&start_file_sn=&end_file_sn=&svc_path_nm=&epid=&candidate_nm=&elect_ymd=&epdata_id=&ctl_no_id=&elect_sn=&party_nm=&win_yn=&elecDe=&turnDe=%B4%EB%C5%EB%B7%C9%BC%B1%B0%C5&elecType=10&code_id=10++&elecTypeMax=20&turnType=EPS0410++&cityType=EPS0410{p_number}&guType=&sign_id={p_number}&sido_nm=&elect_region_nm=&fieldName=candidate_nm&category=tms120tbl&myScraps=&kwd=&elecTypes=10&electionType=on&electionTurn=on&pageSize=20&order=elect_ymd&order_sort=desc")
  
  poster_text <- president_poster_url %>% 
    read_html() %>% 
    html_nodes(xpath = '//*[@id="content"]/div[5]/ul') %>% 
    html_nodes(css = "li") %>% 
    html_nodes(css = "input") %>% 
    html_attr("value")
  
  poster_list <- poster_text %>% 
    str_split(pattern = "(\\s+\\|\\s+)|(,)")
  
  poster_president_tbl <- tibble(후보      = map_chr(poster_list, 1),
                                 선거일    = map_chr(poster_list, 2),
                                 선거      = map_chr(poster_list, 3),
                                 선거구분  = map_chr(poster_list, 4),
                                 구분1     = map_chr(poster_list, 5),
                                 구분2     = map_chr(poster_list, 6),
                                 기호      = map_chr(poster_list, 7),
                                 정당      = map_chr(poster_list, 8),
                                 당락      = map_chr(poster_list, 9))
  
  return(poster_president_tbl)
}

get_poster_info(6)
```

일부 대통령 선거 데이터가 빠져 있어 6대, 12~19대까지 포스터를 데이터프레임으로 데이터화한다.

```{r get-all-poster-tbl, eval = FALSE}

all_poster_tbl <- map_df(1:19, get_poster_info)

all_poster_tbl %>% 
  write_csv("data/all_poster_tbl.csv")
```

## 포스트 데이터프레임 {#poster-dataframe}

```{r post-data-frame}
all_poster_tbl <- read_csv("data/all_poster_tbl.csv")

all_poster_tbl %>% 
  reactable::reactable()
```

# 선거 벽보 이미지 

## 벽보 이미지 위치 

```{r download-poster-image}

poster_url <- "http://elecinfo.nec.go.kr/neweps/3/1/paperSearch.do?chs=&page=&epType=&start_file_sn=&end_file_sn=&svc_path_nm=&epid=&candidate_nm=&elect_ymd=&epdata_id=&ctl_no_id=&elect_sn=&party_nm=&win_yn=&elecDe=&turnDe=%B4%EB%C5%EB%B7%C9%BC%B1%B0%C5&elecType=10&code_id=10++&elecTypeMax=20&turnType=EPS0410++&cityType=EPS041019&guType=&sign_id=19&sido_nm=&elect_region_nm=&fieldName=candidate_nm&category=tms120tbl&myScraps=&kwd=&elecTypes=10&electionType=on&electionTurn=on&pageSize=20&order=elect_ymd&order_sort=desc"

poster_html <- poster_url %>% 
    read_html()

poster_buttons <- poster_html %>% 
    html_nodes(xpath = '//*[@id="content"]/div[5]/ul') %>% 
    html_nodes(css = "a") %>% 
    html_attr("href")

pdf_files <- poster_buttons[str_detect(poster_buttons, pattern = "start_file")] 

pdf_poster_files <- pdf_files[str_detect(pdf_files, pattern = "ECM0120170006")]    

glue::glue("http://elecinfo.nec.go.kr{pdf_poster_files}")

```


## 벽보 이미지 함수 

```{r download-poster-image-function, eval = FALSE}

get_image_address <- function(p_number) {
    poster_url <- glue::glue("http://elecinfo.nec.go.kr/neweps/3/1/paperSearch.do?chs=&page=&epType=&start_file_sn=&end_file_sn=&svc_path_nm=&epid=&candidate_nm=&elect_ymd=&epdata_id=&ctl_no_id=&elect_sn=&party_nm=&win_yn=&elecDe=&turnDe=%B4%EB%C5%EB%B7%C9%BC%B1%B0%C5&elecType=10&code_id=10++&elecTypeMax=20&turnType=EPS0410++&cityType=EPS0410{p_number}&guType=&sign_id={p_number}&sido_nm=&elect_region_nm=&fieldName=candidate_nm&category=tms120tbl&myScraps=&kwd=&elecTypes=10&electionType=on&electionTurn=on&pageSize=20&order=elect_ymd&order_sort=desc")
  
  poster_html <- poster_url %>% 
      read_html()
  
  poster_buttons <- poster_html %>% 
      html_nodes(xpath = '//*[@id="content"]/div[5]/ul') %>% 
      html_nodes(css = "a") %>% 
      html_attr("href")
  
  pdf_files <- poster_buttons[str_detect(poster_buttons, pattern = "start_file")] 
  
  pdf_files_url <- glue::glue("http://elecinfo.nec.go.kr{pdf_files}")
  
  return(pdf_files_url)
}


# pdf_poster_files <- pdf_files[str_detect(pdf_files, pattern = "ECM0120170006")]    

p_number <- str_pad(1:19, width = 2, side = "left", pad = "0")

poster_url_vec <- map(p_number, get_image_address)

poster_url_vec %>% 
  write_rds("data/poster/poster_url_vec.rds")
```

## 벽보 이미지 다운로드 

```{r donot-run, eval = FALSE}
all_poster_tbl <- read_csv("data/all_poster_tbl.csv")
poster_url_vec <- read_rds("data/poster/poster_url_vec.rds")

## 제 6 대 대통령선거 -------
six_poster_tbl <- all_poster_tbl %>% 
  mutate(기호 = str_remove_all(기호, "기호\\s+")) %>% 
  filter(선거 == "6대") %>% 
  mutate(image_url = poster_url_vec[[6]]) %>% 
  mutate(filename  = glue::glue("data/poster/{선거}_{후보}_{기호}.pdf"))

map2(six_poster_tbl$image_url, six_poster_tbl$filename, download.file, mode = "wb")

## 제 13 대 대통령선거 -------
poster_13_tbl <- all_poster_tbl %>% 
  mutate(기호 = str_remove_all(기호, "기호\\s+")) %>% 
  filter(선거 == "13대") %>% 
  mutate(image_url = poster_url_vec[[13]]) %>% 
  mutate(filename  = glue::glue("data/poster/{선거}_{후보}_{기호}.pdf"))

map2(poster_13_tbl$image_url, poster_13_tbl$filename, download.file, mode = "wb")

## 제 14 대 대통령선거 -------
poster_14_tbl <- all_poster_tbl %>% 
  mutate(기호 = str_remove_all(기호, "기호\\s+")) %>% 
  filter(선거 == "14대") %>% 
  mutate(image_url = poster_url_vec[[14]]) %>% 
  mutate(filename  = glue::glue("data/poster/{선거}_{후보}_{기호}.pdf"))

map2(poster_14_tbl$image_url, poster_14_tbl$filename, download.file, mode = "wb")

## 제 15 대 대통령선거 -------
poster_15_tbl <- all_poster_tbl %>% 
  mutate(기호 = str_remove_all(기호, "기호\\s+")) %>% 
  filter(선거 == "15대") %>% 
  mutate(image_url = poster_url_vec[[15]]) %>% 
  mutate(filename  = glue::glue("data/poster/{선거}_{후보}_{기호}.pdf"))

map2(poster_15_tbl$image_url, poster_15_tbl$filename, download.file, mode = "wb")

## 제 16 대 대통령선거 -------
poster_16_tbl <- all_poster_tbl %>% 
  mutate(기호 = str_remove_all(기호, "기호\\s+")) %>% 
  filter(선거 == "16대") %>% 
  mutate(image_url = poster_url_vec[[16]]) %>% 
  mutate(filename  = glue::glue("data/poster/{선거}_{후보}_{기호}.pdf"))

map2(poster_16_tbl$image_url, poster_16_tbl$filename, download.file, mode = "wb")

## 제 17 대 대통령선거 -------
poster_url_tmp <- poster_url_vec[[17]] 
poster_17_urls <- poster_url_tmp[str_detect(poster_url_tmp, pattern = "ECM0120080029")]    

poster_17_tbl <- all_poster_tbl %>% 
  mutate(기호 = str_remove_all(기호, "기호\\s+")) %>% 
  filter(선거 == "17대") %>% 
  mutate(image_url = poster_17_urls) %>% 
  mutate(filename  = glue::glue("data/poster/{선거}_{후보}_{기호}.pdf"))

map2(poster_17_tbl$image_url, poster_17_tbl$filename, download.file, mode = "wb")

## 제 18 대 대통령선거 -------
poster_url_tmp <- poster_url_vec[[18]] 
poster_18_urls <- poster_url_tmp[str_detect(poster_url_tmp, pattern = "ECM0120121025")]    

poster_18_tbl <- all_poster_tbl %>% 
  mutate(기호 = str_remove_all(기호, "기호\\s+")) %>% 
  filter(선거 == "18대") %>% 
  mutate(image_url = poster_18_urls) %>% 
  mutate(filename  = glue::glue("data/poster/{선거}_{후보}_{기호}.pdf"))

map2(poster_18_tbl$image_url, poster_18_tbl$filename, download.file, mode = "wb")

## 제 19 대 대통령선거 -------
poster_url_tmp <- poster_url_vec[[19]] 
poster_19_urls <- poster_url_tmp[str_detect(poster_url_tmp, pattern = "ECM0120170006")]    

poster_19_tbl <- all_poster_tbl %>% 
  mutate(기호 = str_remove_all(기호, "기호\\s+")) %>% 
  filter(선거 == "19대") %>% 
  mutate(image_url = poster_19_urls) %>% 
  mutate(filename  = glue::glue("data/poster/{선거}_{후보}_{기호}.pdf"))

map2(poster_19_tbl$image_url, poster_19_tbl$filename, download.file, mode = "wb")
```


# 벽보 결합 {#merge-pdfs}

```{r merge-pdf-files, eval = FALSE}
library(pdftools)

poster_pdf_filepath <- fs::dir_ls(path = "data/poster", glob = "*.pdf")

walk(poster_pdf_filepath, pdf_combine, output =  "data/poster.pdf")
```

```{r embed-pdf, out.height = "1200px", out.width='800px', echo=TRUE}
knitr::include_graphics("data/poster.pdf")
```

